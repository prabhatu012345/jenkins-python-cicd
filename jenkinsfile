pipeline {
    agent any

    environment {
        // Define environment variables if needed
        NEXUS_URL = 'http://nexus.prod.urbanbamboo.in:8081/repository/prabhat/'
        TWINE_CREDENTIALS_ID = 'nexus-credentials'  // Jenkins credentials ID for Nexus credentials
    }

    stages {
        stage('Clone Repository') {
            steps {
                git 'https://github.com/prabhatu012345/jenkins-python-cicd.git'
            }
        }

        stage('Build and Package') {
            steps {
                script {
                    // Install dependencies
                    sh 'pip install -r requirements.txt'
                    
                    // Build and package the application
                    sh 'python setup.py sdist bdist_wheel'
                }
            }
        }

        stage('Upload to Nexus') {
            steps {
                script {
                    // Install twine if not installed
                    sh 'pip install twine'

                    // Upload the package to Nexus repository using credentials
                    withCredentials([usernamePassword(credentialsId: "${TWINE_CREDENTIALS_ID}", usernameVariable: 'TWINE_USERNAME', passwordVariable: 'TWINE_PASSWORD')]) {
                        sh '''
                        twine upload --repository-url $NEXUS_URL -u $TWINE_USERNAME -p $TWINE_PASSWORD dist/*
                        '''
                    }
                }
            }
        }
    }
}
